#include "lib.h"
#include "parsing.h"
#include "int.h"

u8 cacatoes[25][25] = 
    {{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 14, 7, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 14, 7, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 14, 7, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 15, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 14, 14, 7, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 7, 15, 14, 14, 7, 0, 0 },
    { 0, 0, 0, 0, 0, 7, 15, 15, 15, 15, 15, 15, 15, 15, 7, 8, 15, 15, 14, 14, 14, 14, 7, 0, 0 },
    { 0, 0, 0, 8, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 15, 0, 0 },
    { 0, 0, 0, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 7, 0, 0 },
    { 0, 0, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 15, 0, 0, 0 },
    { 0, 8, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 15, 0, 0, 0, 0 },
    { 0, 8, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 7, 0, 0, 0, 0, 0 },
    { 0, 8, 7, 7, 7, 7, 7, 7, 7, 15, 15, 15, 15, 15, 15, 15, 15, 15, 8, 0, 0, 0, 0, 0, 0 },
    { 0, 8, 7, 0, 8, 7, 7, 7, 7, 7, 8, 15, 15, 7, 15, 15, 15, 15, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 7, 0, 0, 0, 0, 7, 7, 7, 8, 0, 8, 15, 15, 15, 15, 15, 15, 15, 0, 0, 0, 0, 0, 0 },
    { 0, 15, 7, 8, 8, 0, 8, 7, 7, 7, 8, 7, 15, 15, 15, 15, 15, 15, 15, 0, 0, 0, 0, 0, 0 },
    { 0, 7, 15, 8, 8, 8, 8, 8, 7, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 0, 0, 0, 0, 0, 0 },
    { 0, 8, 7, 8, 7, 7, 7, 7, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 7, 0, 0, 0, 0, 0 },
    { 0, 8, 7, 7, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 0, 0, 0, 0, 0 },
    { 0, 0, 7, 8, 15, 15, 7, 7, 7, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 0, 0, 0, 0, 0 },
    { 0, 0, 7, 8, 7, 15, 7, 7, 15, 7, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 0, 0, 0, 0, 0 },
    { 0, 0, 7, 8, 7, 7, 7, 15, 7, 7, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 0, 0, 0, 0 },
    { 0, 0, 0, 8, 7, 7, 7, 15, 7, 7, 7, 7, 7, 15, 15, 15, 15, 15, 15, 15, 15, 0, 0, 0, 0 },
    { 0, 0, 0, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 15, 15, 15, 15, 15, 15, 15, 0, 0, 0, 0 }};

u8 chars[4] = {176, 177, 178, ' '};
u8 bg_c[4] = { 0, 0, 0, 1 };

void display(int x, int y, int width, int height, int revert, int intensity, u8 bg, u8 *picture) {
    width = 2 * width;
    int first_x = (x < 0) ? (-x) : 0;
    int last_x = min(VGA_WIDTH - 1 - x, width);
    int first_y = (y < 0) ? (-y) : 0;
    int last_y = min(VGA_HEIGHT - 1 - y, height);
    
    u8 bg1;
    u8 fg1;
    u8 c;
    
    for (int j = first_y; j < last_y; j++) {
        esc_seq(ESC_LINE(y + j));
        if (first_x < last_x)
            esc_seq(ESC_COLUMN(x + first_x));
        for (int i = first_x; i < last_x; i++) {
            //printf("i : %d, j %d, addr %x\n", revert ? (width - 1 - i), j, picture);
            c = chars[intensity];
            fg1 = picture[(revert ? (width - 1 - i) : i) / 2 + j * width / 2];
            bg1 = bg_c[intensity] ? fg1 : bg;
            printf("%fg%bg%c", fg1, bg1, c);
            //printf("%bg ", picture[(revert ? (width - 1 - i) : i) / 2 + j * width / 2]);
        }
    }
}

int main(char *args) {
    int x = 0;
    int y = 0;
    esc_seq(ESC_BG(BLACK));
    esc_seq(ESC_ERASE);
    for (;;) {
        x+=2; // TODO Why does +=1 not work ?
        y+=1;
        sleep(10);
        display(x-25, y-25, 25, 25, 1, 3, BLACK, (u8*) cacatoes);
        if (x == 130)
            break;
    }
    printf("\n%fg", WHITE);
    flush(STDOUT);
    exit(EXIT_SUCCESS);
    return 0;
}